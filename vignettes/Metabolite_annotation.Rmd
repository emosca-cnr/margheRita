---
title: "Metabolite_annotation"
auhtor: "zahrasadat alavikakhki"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Metabolite_annotation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r , eval=FALSE}
library(margheRita)
```

#library within the margheRita
margheRita provides a library contains about 600 compounds in five possible column of HILIC, LipC8, pZIC, RPLong, RPShort and positive or negative mode for metabolite identification of unknown metabolite. to generate the library two datasets are provided, one related to precursor contain 16 types of information. Name, Elemental composition, CAS, COL, Unique.Name_lib, rt, mz in NEU, POS and NEG mode, SMILES, KEGG.ID or CHEMSPIDER.ID, HMDB/YMDBID, METLIN.ID, PubChemCID, CHEBI and ID. 
the other one contains 9 features of ID, Name, MW, CAS, Formula, Precursor MZ, Collision energy, Number of the peaks and peaks.
the information that are required for metabolite identification from the first dataset are "ID", "CAS", "Name", "rt", "mz" and "ID", "CAS", "Collision_energy", "Name" and "Peaks" form the second dataset. 

`margheRita_library` function extract these information and stored them in three lists.
-library precursor: it is a list of metabolites which each contains information(features) of retention time and mz with their specific IDs, CAS numbers and names.
-library peaks data:it is a list of metabolites which each contains information of collision energy with their specific IDs, CAS numbers and names.
-library peaks: it is a list of metabolites with same IDs as lib_peaks_data which each contains a list of a peaks with mass to charge ratio and relative intensity. 

```{r, eval=FALSE}
margheRita_library(column = "HILIC", mode = "POS", accept_RI = 10)
```

*`column`: it is specify the type of the column which could be; HILIC, LipC8, pZIC, RPLong or RPShort. based on the type of the column, the retention time of same metabolite could be different. 

*`mode`: mode could be set in positive or negative state. positive mode select positive collision energy and mz in positive mode.

*`accept_RI`: it is a numeric parameter. the default value is 10. it is a maximum relative intensity that we keep in library. since low intense peaks could be noise, it is filtering the library by deleting the relative intensity lower then `accept_RI`.

# generate dataset for metabolite identification 
mass spectroscopy provides us variety of information but for metabolite identification we need only Retention time and m/z and spectra of the known metabolite library and unknown sample to compare them together. 
`annotation_dataset()` function generate required data.

```{r, eval=FALSE}
annotation_dataset(column = "HILIC", mode = "POS", accept_RI = 10)
```


converting intensity to relative intensity


# The workflow of metabolic identification 
beneath of the metabolite annotation function there are four main steps. 

a) Retention time similarity. If RT of precursor in Library is close to RT in Sample
b) mass similarity by calculating PPM error
c) ion mass similarity by calculating PPM error for intensive peaks for MS/MS spectroscopy 

## a)Retention Time similarity
retention time is a measure of the time taken for a solute to pass through a chromatography column and for same metabolites it is taken more or less the same time by considering systematic error we define a tolerance window. Any RT shift of a peak pair that falls outside the tolerance window will result in misalignment of the pair as a different metabolite.

`check_RT()` function make a list of all known metabolite from library and we define a tolerance window of `rt_err_thr` then `check_RT()` function  assign a data frame of unknown candidates to each metabolite based on their presence in a range of tolerance window.

```{r, eval=FALSE}
RT = check_RT(feature_data = NULL , reference = NULL, rt_err_thr= 2)
```

* `feature_data`: it is a data frame contains retention time (rt) and m/z (mz) of the sample which are stored by their specific ID (Feature_ID)

* `reference`: it is a data frame contains retention time (rt) and m/z (mz) of the metabolites which are stored by the name of metabolites (Name), CAS and ID

* `rt_err_thr`: it is tolerance window of retention time that align sample with compound and its default value is 2. 


## b)mass similarity by calculating PPM error
The similarity between two masses is calculated by the ppm error (parts per million) which is determining mass tolerance. The PPM error is calculated as the relative error between the mass of a feature j and mass of the reference in the library i.

according to our study goal, we delete those with bad PPM error and assign a feature to the one with good PPM error in mass status column. 

Ppm error < a – super

Ppm error < b – acceptable, may happen when ions are of low intensities

Ppm error < c – may happen when machine suffer a bit.

Ppm error > c – not good


```{r, eval=FALSE}
mass = check_mass(feature_data = NULL , reference = NULL, unaccept_flag= c, accept_flag= a, suffer_flag= b)
```


### Merging ideal candidate in term of Retention Time and PPM error

```{r, eval=FALSE}
RT_mass = check_RT_mass (RT , mass, reference= NULL )
```

## c) establishing new library & sample data by calculating relative intensity
convert intensity to relative intensity and deleting the negligible relative intensity, both in library and sample spectra.
relative intensity is calculated by dividing ion intensity to the maximum ion intensity in spectra.

```{r, eval=FALSE}
RI_lib = RI_lib_data ( reference = NULL , RT_mass, acceptable_RI = acceptable_RI)
```


```{r, eval=FALSE}
RI_sample = RI_sample_data (feature_spectra= NULL, acceptable_RI = acceptable_RI )
```


![](images/I.png)     
![](images/RI.png)



## d) ions mass similarity by calculating PPM error for intensive peaks for MS/MS spectroscopy 

Those peaks candidate that distinguishing as metabolite i among compound j in the sample have two main criteria at the same time: strong relative intensity and good PPM error. 
the most important peaks are the most intense ones. So, we are calculating the PPM error pick by pick for the most intense ones by contribution of `calc_ppm_err()` function.
the number of the peaks that we are considering depends on the accuracy and goals study.

```{r, eval=FALSE}
intense_peak = check_intense_peak(RT_mass, RI_lib , RI_sample, n_peaks = n_peaks , acceptable_PPM_err = acceptable_PPM_err)
```

 ![](images/trp_plot.png)
 
 # metabolite annotation function 
metabolite annotation function uses the four dataset and default values for retention time threshold, range of acceptable and unacceptable PPM error, acceptable relative intensity in order to have a clean dataset and number of the most intensive peaks which are calculated for acceptable PPM error. all these values are modifiable based on the specificity and goal of the study. 

```{r, eval=FALSE}
metabolites_annotation = metabolite_annotation(feature_data = NULL , reference = NULL , feature_spectra = NULL, reference_spectra= NULL,
                                               rt_err_thr=1, 
                                               unaccept_flag=15, accept_flag=5, suffer_flag=10,
                                               acceptable_RI = 10,
                                               n_peaks=1, acceptable_PPM_err = 10)
```

* `feature_data`: ... parameter, default value is NULL. it is a data frame contains retention time (rt) and m/z (mz) of the sample which are stored by their specific ID (Feature_ID)

* `reference`: ... parameter, default value is NULL. it is a data frame contains retention time (rt) and m/z (mz) of the compounds which are stored by the name of the compound (Name)

* `feature_spectra`: ... parameter, default value is NULL. it is extracted from MS/MS spectroscopy. it is a list of sample ID which each contains list of its m/z and Intensity for each ion

* `reference_spectra`: ... parameter, default value is NULL. it is extracted from MS/MS spectroscopy. it is a list of compounds names which each contains list of its m/z and Intensity for each ion.

* `rt_err_thr`: ...parameter, default value is 1. it is tolerance window of retention time that align sample with compound. 

* `unaccept_flag`: ...parameter, default value is 15. it is specify the unacceptable number for PPM error. the number above this will be deleted.

* `accept_flag`: ...parameter, default value is 5. it is specify a range of the acceptable number for PPM error. PPM error below 5 will tagged by "super" flag and PPM error above 5 and below 10, tagged by "acceptable" flag.

* `suffer_flag`: ...parameter, default value is 10. it is specify a lowest acceptable number for PPM error in suffer group. range of PPM error between 10 and 15 will tagged as "suffer".

* `acceptable_RI`: ...parameter, default value is 10. it is cleaning the data set both in library and sample by deleting the low intensity peaks.

* `n_peaks`: ...parameter, default value is 1. it is specify the number of the most intense peaks of ion in MS/MS data that PPM error are calculated on.

* `acceptable_PPM_err`: ...parameter, default value is 10. it is specify the lowest acceptable PPM error for the ions in MS/MS data.


