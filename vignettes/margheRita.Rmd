---
title: "margheRita"
author: "Edoardo Bellini"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
![](images/logo.png)

# **[margheRita](https://github.com/emosca-cnr/margheRita)**: an R package for analyzing the entire workflow of mass spectrometry-based metabolic profiles.

## Maria Ulaszewska^**1**^ , Edoardo Bellini^**2**^ , Denise Drago^**1**^ , Valeria Mannella^**2**^ , Marco Morelli^**2**^ , Annapaola Andolfo^**1**^ , Ettore Mosca^**3**^

**1**. ProMeFa, Proteomics and Metabolomics Facility, Center for Omics Sciences (COSR), IRCCS San Raffaele Scientific Institute, Milan 20132, Italy

**2**. Center for Omics Sciences (COSR), IRCCS San Raffaele Scientific Institute, Milan 20132, Italy

**3**. National Research Council, Institute of Biomedical Technologies, Segrate (Milan), Italy



  
MargheRita is intended for any kind of mass spectrometer raw data, including both $MS$ and $MS/MS$ data. It takes as input `.txt/.csv` files that contain the metabolic profiles generated by **[MS-Dial](http://prime.psc.riken.jp/compms/msdial/main.html)** and metadata for sample processing. The first pre-processing step performs the integration of the metabolic profiles in a unique data structure and generates plots for quality control about outliers, drifts or batch effects. Then, metabolites and samples can be filtered based on the quantification of mass defect values, missing values and coefficient of variation of m/z features along QC and study samples. Moreover, margheRita provides various methods for missing value imputation and data normalization, including those particular recommended for metabolomic profiles, like the Probabilistic Quotient Normalization (PQN) or the normalization to a standard factor (e.g. protein concentration, urine osmolality). Subsequent analyses include: parametric and non-parametric statistical tests for the identification of significant metabolite signatures; sample clustering; metabolite correlation analysis and pathway analysis (using databases like **[KEGG](https://www.genome.jp/kegg/)** and **[Biocyc](https://biocyc.org)**). Additional advantage derives from the $MS/MS$ data management and annotations with the possibility of data browsing and searching.

## loading the package

The package can be dowloaded **[here](https://github.com/emosca-cnr/margheRita)** and the loading can be done by using the function `load_all()`, of the package `devtools`
```{r}
library(devtools)
load_all("../")
```


## Reading input files

The function `read_input_file()` allows you to inport the dataset and his relative metadata creating margheRita object called m_list, other parameter that can be specified are:

+ `split_QC`: Bolean parameter that split QC samples from the others.

+ `rt_col`: interger parameter, it specifies the number of the column that correspondes to retenction time.

+ `mz_col`: the same for `rt_col`, but for the $m/z$ corrospnding column

+ `data_start_col`: interger parameter that specifies the number of the 
```{r}
m_list <- read_input_file(input = "../inst/extdata/example1.xlsx", metadata = "../inst/extdata/example1_meta.xlsx", split_QC = TRUE, rt_col = 2, mz_col =3 , data_start_col = 4)
```
m_list object created by `read_input_file()` function is this:
![Data structure of margherita](images/m_list_str.png)

Object in m_list  | Description
------------- | -------------
data  | matrix containing all metabolite counts
metab_ann  | annotation of metabolites basic $m/z$ and rt
sample_ann | metadata of samples
QC | matrix containing QC metabolite counts
QC_ann | annotation of metabolites basic $m/z$ and rt only of QC met

## Filtering $m/z$ feature 

Once created the margheRita object `m_list`, can be applied on the function `m_z_filtering()` that is able to filter lower quality $m/z$ mass accuracy features

```{r}
m_list <- m_z_filtering(m_list = m_list, lower_quality_mass_acc = 0.4, upper_quality_mass_acc = 0.8, do_plot = T)
```

+ `m_list`: m_list object.

+ `lower_quality_mass_acc`: floating parameter, it specifies the lower number associated to the firt $m/z$ feature decimal number that will be cutt off.

+ `upper_quality_mass_acc`: floating parameter, it specifies the upper number associated to the firt $m/z$ feature decimal number that will be cutt off.

+ `do_plot`: bulean parameter that specifies if a distribution plot of $m/z$ feature has to be displayed

the command also generate a report of the filtering

    output:
      Metabolites with appropriate m/z values
      idx_keep
      TRUE 
      26888

function output produce in metab_ann a column called quality: 
```{r}
head(m_list$metab_ann, 5)
```

## Calculate Reference
Description here by Ettore :
```{r}
m_list <- calc_reference(m_list = m_list, sample_col = "class", sample_class = "QC", approach = "median")
```

## Normalization
Description here by Ettore :
```{r}
m_list <- normalize_profiles(m_list = m_list, method = "pqn")
```
