---
title: "margheRita"
author: "Edoardo Bellini"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
![](images/logo.png)

# **[margheRita](https://github.com/emosca-cnr/margheRita)**: an R package for analyzing the entire workflow of mass spectrometry-based metabolic profiles.

## Maria Ulaszewska^**1**^ , Edoardo Bellini^**2**^ , Denise Drago^**1**^ , Valeria Mannella^**2**^ , Marco Morelli^**2**^ , Annapaola Andolfo^**1**^ , Ettore Mosca^**3**^

**1**. ProMeFa, Proteomics and Metabolomics Facility, Center for Omics Sciences (COSR), IRCCS San Raffaele Scientific Institute, Milan 20132, Italy

**2**. Center for Omics Sciences (COSR), IRCCS San Raffaele Scientific Institute, Milan 20132, Italy

**3**. National Research Council, Institute of Biomedical Technologies, Segrate (Milan), Italy



  
MargheRita is intended for any kind of mass spectrometer raw data, including both $MS$ and $MS/MS$ data. It takes as input `.txt/.csv` files that contain the metabolic profiles generated by **[MS-Dial](http://prime.psc.riken.jp/compms/msdial/main.html)** and metadata for sample processing. The first pre-processing step performs the integration of the metabolic profiles in a unique data structure and generates plots for quality control about outliers, drifts or batch effects. Then, metabolites and samples can be filtered based on the quantification of mass defect values, missing values and coefficient of variation of m/z features along QC and study samples. Moreover, margheRita provides various methods for missing value imputation and data normalization, including those particular recommended for metabolomic profiles, like the Probabilistic Quotient Normalization (PQN) or the normalization to a standard factor (e.g. protein concentration, urine osmolality). Subsequent analyses include: parametric and non-parametric statistical tests for the identification of significant metabolite signatures; sample clustering; metabolite correlation analysis and pathway analysis (using databases like **[KEGG](https://www.genome.jp/kegg/)** and **[Biocyc](https://biocyc.org)**). Additional advantage derives from the $MS/MS$ data management and annotations with the possibility of data browsing and searching.

## Installation and loading the package

The package can be dowloaded **[here](https://github.com/emosca-cnr/margheRita)** and the loading can be done by using the function `load_all()`, of the package `devtools`
```{r, eval=FALSE}
if (!requireNamespace("devtools", quietly = TRUE)) {
  install.packages("devtools")
}
devtools::install_github("emosca-cnr/margheRita", dependencies = T)
install_dependencies("marghRita")
load_all("margheRita")
```


## Reading input files

The function `read_input_file()` allows you to inport the dataset and his relative metadata creating margheRita object called m_list, other parameter that can be specified are:

+ `split_QC`: Bolean parameter that split QC samples from the others.

+ `rt_col`: interger parameter, it specifies the number of the column that correspondes to retenction time.

+ `mz_col`: the same for `rt_col`, but for the $m/z$ corrospnding column

+ `data_start_col`: interger parameter that specifies the number of the 
```{r, eval=FALSE}
m_list <- read_input_file(input = "inst/extdata/example1.xlsx", metadata = "inst/extdata/example1_meta.xlsx", split_QC = TRUE, rt_col = 2, mz_col =3 , data_start_col = 4)
```
m_list object created by `read_input_file()` function is this:
![Data structure of margheRita](images/m_list_str.png)

Object in m_list  | Description
------------- | -------------
data  | matrix containing all metabolite counts
metab_ann  | annotation of metabolites basic $m/z$ and rt
sample_ann | metadata of samples
QC | matrix containing QC metabolite counts
QC_ann | annotation of metabolites basic $m/z$ and rt only of QC met

## Filtering $m/z$ feature 

Once created the margheRita object `m_list`, can be applied on the function `m_z_filtering()` that is able to filter lower quality $m/z$ mass accuracy features

```{r, eval=FALSE}
m_list <- m_z_filtering(m_list = m_list, lower_quality_mass_acc = 0.4, upper_quality_mass_acc = 0.8, do_plot = T, color="black")
```

+ `m_list`: m_list object.

+ `lower_quality_mass_acc`: floating parameter, it specifies the lower number associated to the firt $m/z$ feature decimal number that will be cutt off.

+ `upper_quality_mass_acc`: floating parameter, it specifies the upper number associated to the firt $m/z$ feature decimal number that will be cutt off.

+ `do_plot`: bulean parameter that specifies if a distribution plot of $m/z$ feature has to be displayed

+ `color`: character spcecifyng the color of the curve. 

the command also generate a report of the filtering

    output:
      Metabolites with appropriate m/z values
      idx_keep
      TRUE 
      26888

function output produce in metab_ann a column called quality: 
```{r, eval=FALSE}
head(m_list$metab_ann, 5)
```

## Data exploration
margheRita provides two types of functions that are able to explore data:

### Heatscatter_Cromatography
this function provide an overview of all the $m/z$ features in all experiments during all the chromatogram, by generating a Heatscatter plot using `LSD::heatscatter()` function exploiting **[LSD package](https://cran.r-project.org/web/packages/LSD/index.html)**
```{r, eval=FALSE}
heatscatter_chromatography(m_list = m_list, mz_limits = NULL, rt_limits = NULL, sample = c("BAL_STAND"))
```
+ `sample`: character parameter, default value is `NULL`, if specified in the plot will be provided only $m/z$ feature present in that specific sample.

+ `mz_limits`: vector parameter, default value is `NULL`, that specifies the minimum and maximum value of the $m/z$ features window that have to be displayed.

+ `rt_limits`: vector parameter, default value is `NULL`, that specifies the minimum and maximum value of the retenction time window that have to be displayed.

![](images/hetascatter.png)


### exp_mz_rt


## Calculate Reference
Description here by Ettore :
```{r, eval=FALSE}
m_list <- calc_reference(m_list = m_list, sample_col = "class", sample_class = "QC", approach = "median")
```

## Normalization
Description here by Ettore :
```{r, eval=FALSE}
m_list <- normalize_profiles(m_list = m_list, method = "pqn")
```

## Calculation of statistical parameter of $m/z$ features 
This function allows to retrive principal descriptive statistics indexes for all $m/z$ features, in particular function retrive for all feature across all sample the intesites mean 
```{r, eval=FALSE}
m_list <- mean_media_stdev_samples(m_list, write_output = F)
```




## Differential analysis
margheRita implements the of differential abundance analisys by using the fold change index: $log_2(\frac{\bar{B}}{\bar{A}})$ where $\bar{B}$ and $\bar{A}$ are respectably the second and the first term of the specified contrast. Within margheRita regarding this context were implemented two functions:
```{r, eval=FALSE}
m_list <- calculate_lfc_all(m_list = m_list, lfc_theshold = 0.25)
```
This function allow to perform for all $m/z$ feature the fold change, among all useful pairwise comparisons, the specifiable parameters of the function are:
+ `lfc_theshold`: an integer representing the fold change upper which the corresponding negative value and lower which the corresponding positive value, a $m/z$ is condider significative or not, (so for example if a user specifies `lfc_theshold=0.25` all $-0.25<log_2(Fold Change)>+0.25$ are consider not significative and the function assign value 0).
If the user is interest to a specific contrast a second function in witch you can specify was constructed:
```{r, eval=F}
m_list <- calculate_lfc(m_list = m_list, lfc_theshold = 0.25, contrast_samples = c("BAL_STAND", "NOD_STAND"))

```
+ `contrast_samples`: is a character vector of samples specified in the metadata.









